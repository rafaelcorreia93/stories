<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stories</title>
<style>
/* The Modal (background) */
.modal {
  display: none; /* Hidden by default */
  position: fixed; /* Stay in place */
  z-index: 1; /* Sit on top */
  left: 0;
  top: 0;
  width: 100%; /* Full width */
  height: 100vh; /* Full height */
  height: 100dvh; /* Full height */
  overflow: auto; /* Enable scroll if needed */
  background-color: rgb(0,0,0); /* Fallback color */
  background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
  align-items: center;
  min-height: -webkit-fill-available;
}

.story-thumb img {
    width: 100%;
    height: 100%;
}

ul {
    list-style-type: none;
    overflow: auto;
    white-space: nowrap;
}

.story-thumb {
    height: 80px;
    width: 80px;
    overflow: hidden;
    border-radius: 50%;
    border: 5px solid red;
    cursor: pointer;
    background-size: cover;
}
li.story {
    display: inline-block;
    margin: 10px;
    text-align: center
}
.modal-container {
    box-sizing: border-box;
    width: 90%;
    border-radius: 10px;
    height: 80%;
    max-width: 500px;
    margin: auto;
    position: relative;
    box-shadow: 4px 7px 20px #61616187;
    overflow: hidden;
}
.controler {
    position: absolute;
    width: 60px;
    height: 60px;
    cursor: pointer;
    border-radius: 50%;
    background: #ff000000;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all .5s ease;
    z-index: 1;
}
.controler.transition {
    background: #ff0000;
}
.controler.next {
    right: 0;
    top: calc(50% - 40px);
}
.controler.before {
    transform: rotate(180deg);
    left: 0;
    top: calc(50% - 40px);
}
.controler svg {
    filter: drop-shadow(2px 5px 7px rgb(0 0 0 / 0.9));
}
.lido .story-thumb {
    border-color: #e2e2e2;
}
.arrow {
    display: inline-block;
    height: 100%;
    width: 100%;
}
.story-titulo {
    position: absolute;
    bottom: 0;
    background: #e33e5a;
    width: 100%;
    font-size: 2em;;
    padding: 35px;
    box-sizing: border-box;
    color: #fff;
    font-family: 'Open sans', sans-serif;
    font-weight: 700;
    height: 40%;
    display: flex;
    flex-direction: column;
    justify-content: space-evenly;
    z-index: 1;
}
.image-holder {
    height: 60%;
    background-size: cover;
    background-position: center;
    position: absolute;
    width: 100%;
    z-index: 0;
}

.btn-url {
    display: block;
    margin: 20px 0 0 0;
    padding: 10px 25px;
    font-size: 22px;
    font-weight: 600;
    color: #fff;
    background: #3C2E88;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    width: fit-content;
    text-decoration: none;
}

.story span {
    font-family: 'Open Sans', sans-serif;
    text-align: center;
    line-height: 35px;
}

#indicadores {
    position: absolute;
    bottom: 10px;
    text-align: center;
    width: 100%;
}
#indicadores span {
    width: 10px;
    height: 10px;
    background: #ffffff;
    display: inline-block;
    padding: 1px;
    border-radius: 50%;
    margin: 0 7px;
    z-index: 1;
}
#indicadores span.indicador-ativo {
    background: #2a2a2a;
}
#btn-backdrop {
    background: #e33e5a9e;
    width: 60px;
    height: 60px;
    position: absolute;
    top: calc(50% - 40px);
    z-index: 0;
    border-radius: 50%;
    transform: scale(0);
    transition: all .1s ease-out;
}
    </style>
</head>
<body>
    <ul id="lista">
    </ul>
    <div id="myModal" class="modal">

        <div class="modal-container" id="gesture-area">
            <!-- Modal content -->
            <div class="modal-content" id="modal-content">
            </div>
            <!-- Modal controler -->
            <div class="controler before" id="iconBefore" onclick="before()">
                <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" fill="#FFF" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708"/>
                  </svg>            </div>
            <div class="controler next" id="iconNext" onclick="next()">
                <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" fill="#FFF" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708"/>
                  </svg>
            </div>
            <div id="btn-backdrop"></div>
            <div id="indicadores"></div>
        </div>

      
    </div>
    <script>
        var data = `
        [
    {
        "id": "1",
        "tituloThumb": "Teste 1",
        "titulo": "Teste Titulo 1",
        "imgSrc": "https://www3.vivest.com.br/api/assets/vivest-portal/be0fa6ec-cd0b-405a-903b-2579ceb0c3fe/",
        "url": "https://www.vivest.com.br/site/paginas/sobre-nos"
    },
    {
        "id": "2",
        "tituloThumb": "Teste 2",
        "titulo": "Teste Titulo 2",
        "imgSrc": "https://www3.vivest.com.br/api/assets/vivest-portal/eaafe3ad-53cf-4c9a-a269-48685705cfd4/",
        "url": "https://www.vivest.com.br/site/paginas/governanca"
    },
    {
        "id": "3",
        "tituloThumb": "Teste 3",
        "titulo": "Teste Titulo 3",
        "imgSrc": "https://www3.vivest.com.br/api/assets/vivest-portal/316350db-02ea-4fa5-9e40-8c68cee62221/",
        "url": "https://www.vivest.com.br/site/paginas/carreira"
    }
    ]

        `
        var dataStories = [];
        var currentStory = 0;
        var lidos = [];
        // Get the modal
        var modal = document.getElementById("myModal");

        //get modal content
        var modalcontent = document.getElementById('modal-content');

        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
            closeModal();
        }
        window.ontouchend = function(event) {
        if (event.target == modal) {
            closeModal();
        }
        }
        }


        window.onload = function() {
            // recupera stories
            dataStories = JSON.parse( data );

            dataStories.forEach(function (story, index) {
                // criar indicadores
                var indicadoresContainer = document.getElementById('indicadores');
                var indicadorEl = document.createElement('span');
                indicadorEl.setAttribute('id', 'indicador-' + index);
                indicadoresContainer.appendChild(indicadorEl);
            });

            // verifica lidos
            storageContent = JSON.parse(localStorage.getItem("lidos"));
            if (storageContent != null) { lidos = storageContent }

            var dataStoriesUpdated = dataStories.map(originalStory => { 
                if(lidos.includes(Number(originalStory.id))) {
                    originalStory.lido = true;
                    return originalStory;
                } else {
                    originalStory.lido = false;
                    return originalStory;
                }
            });
            dataStoriesUpdated.sort((b, a) => b.lido - a.lido);
            
            // get List
            var lista = document.getElementById("lista");

            dataStoriesUpdated.forEach(function (story, index) {
                var storyItem = document.createElement("li");
                storyItem.setAttribute("class", "story");
                storyItem.setAttribute("id", story.id);
                storyItem.setAttribute("data-index", index);
                if(lidos.includes(Number(story.id))) { storyItem.classList.add("lido"); }
                var storyContent = document.createElement("div");
                storyContent.setAttribute("class", "story-thumb");
                storyContent.style.backgroundImage = "url(" + story.imgSrc + ")";
                var storyThumbTitle = document.createElement("span");
                storyThumbTitle.innerText = story.tituloThumb;
                storyItem.appendChild(storyContent);
                storyItem.appendChild(storyThumbTitle);
                lista.appendChild(storyItem);
            });

            var elements = document.getElementsByClassName("story");

            for (var i = 0; i < elements.length; i++) {
                elements[i].addEventListener('click', function() {openStory(this.id, this.dataset.index, this)});
            }

        };

        function openStory(storyId, index, el) {
            el.classList.add("lido");
            currentStory = Number(index);
            var contents = dataStories.filter(obj => {  return obj.id === storyId });
            if (contents.length) {
                modal.style.display = "flex";

                // criar titulo
                var elTitulo = document.createElement("div");
                elTitulo.classList.add("story-titulo");
                var text = document.createElement("span");
                text.innerText = contents[0].titulo;
                elTitulo.appendChild(text);
                modalcontent.appendChild(elTitulo);

                // criar imagem
                var imageHolder = document.createElement("div");
                imageHolder.classList.add("image-holder");
                imageHolder.style.backgroundImage = "url(" + contents[0].imgSrc + ")";
                modalcontent.appendChild(imageHolder);

                // criar bot√£o
                var btnUrl = document.createElement("a");
                btnUrl.classList.add("btn-url");
                btnUrl.innerHTML = "Saiba mais";
                btnUrl.setAttribute("href", contents[0].url);
                btnUrl.setAttribute("target", "_blank");
                elTitulo.appendChild(btnUrl);

                // salva no storage ID do item lido
                if(!lidos.includes(Number(storyId))) { lidos.push(Number(storyId)); }
                localStorage.setItem("lidos", JSON.stringify(lidos));

                // marca indicador ativo
                document.getElementById('indicador-'+index).classList.add('indicador-ativo');
            } else {
                modal.style.display = "none";
            }
        }

        function closeModal() {
            document.getElementById('indicador-'+currentStory).classList.remove('indicador-ativo');
            modal.style.display = "none";
            modalcontent.innerHTML = "";
        }

        function next() {
            var nextStoryIndex = (currentStory + 1) == dataStories.length ? 0 : Number(currentStory) + 1;
            var storyElement = document.getElementById(dataStories[nextStoryIndex].id);
            closeModal();
            openStory(dataStories[nextStoryIndex].id, nextStoryIndex,storyElement);
        }

        function before() {
            var beforeStoryIndex = currentStory == 0 ? (dataStories.length - 1) : Number(currentStory) - 1;
            var storyElement = document.getElementById(dataStories[beforeStoryIndex].id);
            closeModal();
            openStory(dataStories[beforeStoryIndex].id, beforeStoryIndex,storyElement);
        }


        // gestures


        let pageWidth = window.innerWidth || document.body.clientWidth;
        let treshold = Math.max(1,Math.floor(0.01 * (pageWidth)));
        let touchstartX = 0;
        let touchstartY = 0;
        let touchendX = 0;
        let touchendY = 0;

        var gestureincrement = 0;

        const limit = Math.tan(150 * 1.5 / 180 * Math.PI);
        const gestureZone = document.getElementById('gesture-area');

        gestureZone.addEventListener('touchstart', function(event) {
            touchstartX = event.changedTouches[0].screenX;
            touchstartY = event.changedTouches[0].screenY;
        }, false);

        gestureZone.addEventListener('touchend', function(event) {
            touchendX = event.changedTouches[0].screenX;
            touchendY = event.changedTouches[0].screenY;
            handleGesture(event);
            gestureincrement = 0;
            document.getElementById('btn-backdrop').style.transform = 'scale(' + 0 + ')';
        }, false);

        gestureZone.addEventListener("touchmove", function(event) {
            gestureincrement = gestureincrement == 0 ? 2 : gestureincrement + 4;
            // right
            if (event.changedTouches[0].screenX < touchstartX) {
                document.getElementById('btn-backdrop').style.right = 0;
                document.getElementById('btn-backdrop').style.left = 'inherit';
                document.getElementById('btn-backdrop').style.transform = 'scale(' + gestureincrement/25 + ')';
            } // left
            else {
                document.getElementById('btn-backdrop').style.left = 0;
                document.getElementById('btn-backdrop').style.right = 'inherit';
                document.getElementById('btn-backdrop').style.transform = 'scale(' + gestureincrement/25 + ')';
            }
            
        });

        function handleGesture(e) {
            let x = touchendX - touchstartX;
            let y = touchendY - touchstartY;
            let xy = Math.abs(x / y);
            let yx = Math.abs(y / x);
            if (Math.abs(x) > treshold || Math.abs(y) > treshold) {
                if (yx <= limit) {
                    if (x < -100) {
                        next();
                        gestureincrement = 0;
                        document.getElementById('iconNext').classList.remove('transition');
                    }
                    if (x > 100) {
                        before();
                        gestureincrement = 0;
                    }
                }
            } else {
                console.log("tap");
            }
        }
    </script>
</body>
</html>